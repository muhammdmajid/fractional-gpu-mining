############################################################ 
# üåê Makefile ‚Äî Nginx + Next.js Standalone Deployment
# ---------------------------------------------------------
# Author: Zahid Khan
# Version: 2.1
############################################################


# ==========================================================
# üîß VARIABLES
# ==========================================================
DOMAIN             := fgpumining.site
APP_DIR            := /var/www/gpu_mining_app
NGINX_SITE_DIR     := /etc/nginx/sites-available
NGINX_ENABLED_DIR  := /etc/nginx/sites-enabled
CONFIG_FILE        := $(NGINX_SITE_DIR)/$(DOMAIN)
LOCAL_CONF_PATH    := $(APP_DIR)/nginx/fgpumining.site.conf
DEFAULT_CONF       := /etc/nginx/sites-available/default
HEADERS_CONF_LOCAL := $(APP_DIR)/nginx/headers.conf
HEADERS_CONF_DEST  := /etc/nginx/conf.d/headers.conf

# === ANSI COLORS ===
GREEN   := \033[1;32m
RED     := \033[1;31m
YELLOW  := \033[1;33m
CYAN    := \033[1;36m
BLUE    := \033[1;34m
RESET   := \033[0m

# ==========================================================
# üß≠ HELP MENU
# ==========================================================
help:
	@echo ""
	@echo "$(CYAN)üåç Nginx + Next.js Deployment Helper$(RESET)"
	@echo "==============================================================="
	@echo "$(YELLOW)Usage:$(RESET) make <target>"
	@echo ""
	@echo "$(YELLOW)Available Commands:$(RESET)"
	@echo "  $(GREEN)deploy-all        $(RESET)‚Üí Full automated setup pipeline"
	@echo "  $(GREEN)install           $(RESET)‚Üí Install and enable Nginx"
	@echo "  $(GREEN)setup-dir         $(RESET)‚Üí Create app directory structure"
	@echo "  $(GREEN)copy-config       $(RESET)‚Üí Deploy Nginx config file"
	@echo "  $(GREEN)test              $(RESET)‚Üí Validate Nginx configuration"
	@echo "  $(GREEN)start             $(RESET)‚Üí Start Nginx service"
	@echo "  $(GREEN)stop              $(RESET)‚Üí Stop Nginx service"
	@echo "  $(GREEN)restart           $(RESET)‚Üí Restart Nginx service"
	@echo "  $(GREEN)reload            $(RESET)‚Üí Reload configuration live"
	@echo "  $(GREEN)restart-clean     $(RESET)‚Üí Stop ‚Üí Free Ports ‚Üí Start fresh"
	@echo "  $(GREEN)free-ports        $(RESET)‚Üí Release ports 80/443 manually"
	@echo "  $(GREEN)enable-ssl        $(RESET)‚Üí Configure SSL with Certbot"
	@echo "  $(GREEN)test-site         $(RESET)‚Üí Check HTTP & HTTPS responses"
	@echo "  $(GREEN)rollback-config   $(RESET)‚Üí Restore default Nginx config"
	@echo "  $(GREEN)clean             $(RESET)‚Üí Remove site configuration"
	@echo "==============================================================="
	@echo "$(CYAN)üí° Tip: Run 'make deploy-all' for a complete setup.$(RESET)"
	@echo ""


# ==========================================================
# üöÄ FULL DEPLOYMENT PIPELINE
# ==========================================================
# ==========================================================
# üöÄ FULL DEPLOYMENT PIPELINE
# ==========================================================
deploy-all:
	@echo "$(YELLOW)üöÄ Starting full deployment for $(DOMAIN)...$(RESET)"
	@$(MAKE) setup-dir
	@$(MAKE) copy-config
	@$(MAKE) stop
	@$(MAKE) free-ports
	@$(MAKE) start
	@$(MAKE) reload
	@$(MAKE) test

	@echo "$(CYAN)üîí Enabling SSL for $(DOMAIN)...$(RESET)"
	@$(MAKE) enable-ssl

	@echo "$(YELLOW)üåç Verifying site accessibility...$(RESET)"
	@$(MAKE) test-site

	@echo ""
	@echo "$(GREEN)üéâ Deployment complete!$(RESET)"
	@echo "$(CYAN)‚û°Ô∏è  Visit your site:$(RESET) https://$(DOMAIN)"
	@echo "$(CYAN)‚û°Ô∏è  Nginx config path:$(RESET) $(CONFIG_FILE)"
	@echo "$(CYAN)‚û°Ô∏è  App directory:$(RESET) $(APP_DIR)"
	@echo ""


# ==========================================================
# 1Ô∏è‚É£ INSTALL & ENABLE NGINX
# ==========================================================
install:
	@echo "$(YELLOW)üì¶ Installing Nginx...$(RESET)"
	@if ! command -v nginx >/dev/null 2>&1; then \
		sudo apt update -y && sudo apt install -y nginx; \
	else echo "$(GREEN)‚úÖ Nginx already installed.$(RESET)"; fi
	@sudo systemctl enable nginx --now
	@sudo ufw allow 'Nginx Full' >/dev/null 2>&1 || true
	@sudo systemctl status nginx --no-pager | grep -E "Active|Loaded" || true


# ==========================================================
# 2Ô∏è‚É£ DIRECTORY SETUP
# ==========================================================
setup-dir:
	@echo "$(YELLOW)üìÅ Setting up application directory...$(RESET)"
	@sudo mkdir -p $(APP_DIR)
	@sudo chown -R www-data:www-data $(APP_DIR)
	@sudo chmod -R 755 $(APP_DIR)
	@echo "$(GREEN)‚úÖ Directory structure ready.$(RESET)"


# ==========================================================
# 3Ô∏è‚É£ DEPLOY NGINX CONFIGURATION
# ==========================================================
copy-config:
	@echo "$(YELLOW)‚öôÔ∏è Deploying Nginx configuration for $(DOMAIN)...$(RESET)"

	@echo "$(YELLOW)üìã Copying headers configuration...$(RESET)"
	@if [ ! -f "$(HEADERS_CONF_LOCAL)" ]; then \
		echo "$(RED)‚ùå Missing headers file: $(HEADERS_CONF_LOCAL)$(RESET)"; exit 1; \
	fi
	@sudo cp $(HEADERS_CONF_LOCAL) $(HEADERS_CONF_DEST)
	@echo "$(GREEN)‚úÖ Headers configuration copied to $(HEADERS_CONF_DEST).$(RESET)"

	@echo "$(YELLOW)üßæ Copying site configuration...$(RESET)"
	@if [ ! -f "$(LOCAL_CONF_PATH)" ]; then \
		echo "$(RED)‚ùå Missing site config: $(LOCAL_CONF_PATH)$(RESET)"; exit 1; \
	fi
	@sudo cp $(LOCAL_CONF_PATH) $(CONFIG_FILE)
	@sudo ln -sf $(CONFIG_FILE) $(NGINX_ENABLED_DIR)/$(DOMAIN)
	@echo "$(GREEN)‚úÖ Site configuration deployed.$(RESET)"

	@echo "$(CYAN)üîç Validating Nginx configuration...$(RESET)"
	@sudo nginx -t || (echo "$(RED)‚ùå Nginx config test failed!$(RESET)" && exit 1)
	@echo "$(GREEN)‚úÖ Nginx configuration is valid.$(RESET)"

# ==========================================================
# 4Ô∏è‚É£ VALIDATE NGINX CONFIGURATION
# ==========================================================
test:
	@echo "$(YELLOW)üß™ Validating Nginx syntax...$(RESET)"
	@if sudo nginx -t; then \
		echo "$(GREEN)‚úÖ Configuration syntax valid.$(RESET)"; \
	else \
		echo "$(RED)‚ùå Syntax test failed!$(RESET)"; \
		$(MAKE) rollback-config; \
		exit 1; \
	fi


# ==========================================================
# 5Ô∏è‚É£ CONTROL NGINX SERVICE
# ==========================================================
start:
	@echo "$(YELLOW)‚ñ∂Ô∏è Starting Nginx service...$(RESET)"
	@sudo ufw allow 80/tcp >/dev/null 2>&1 || true
	@sudo ufw allow 443/tcp >/dev/null 2>&1 || true
	@sudo ufw allow 'Nginx Full' >/dev/null 2>&1 || true
	@if systemctl is-active --quiet nginx; then \
		echo "$(GREEN)‚úÖ Nginx already running.$(RESET)"; \
	else \
		sudo systemctl enable nginx >/dev/null 2>&1 || true; \
		if sudo systemctl start nginx >/dev/null 2>&1; then \
			echo "$(GREEN)‚úÖ Nginx started successfully.$(RESET)"; \
		else \
			echo "$(RED)‚ùå Failed to start Nginx.$(RESET)"; \
			sudo journalctl -u nginx -n 10 --no-pager; \
			exit 1; \
		fi; \
	fi
	@sleep 1
	@echo "$(BLUE)üîç Verifying service status...$(RESET)"
	@if systemctl is-active --quiet nginx; then \
		echo "$(GREEN)‚úÖ Active and running.$(RESET)"; \
	else \
		echo "$(RED)‚ùå Nginx is not running after start attempt.$(RESET)"; \
	fi


# ==========================================================
# üõë STOP NGINX (Safe + Clean)
# ==========================================================
stop:
	@echo "$(YELLOW)‚èπÔ∏è  Stopping Nginx service and freeing resources...$(RESET)"

	@echo "$(CYAN)üîß Attempting graceful stop...$(RESET)"
	@if sudo systemctl stop nginx >/dev/null 2>&1; then \
		echo "$(GREEN)‚úÖ Nginx stopped successfully via systemctl.$(RESET)"; \
	else \
		echo "$(RED)‚ö†Ô∏è systemctl stop failed ‚Äî killing processes manually.$(RESET)"; \
	fi

	@echo "$(CYAN)üî´ Terminating remaining nginx worker/master processes...$(RESET)"
	@sudo pkill -f nginx 2>/dev/null || true

	@echo "$(CYAN)üßπ Releasing occupied ports (80 & 443)...$(RESET)"
	@sudo lsof -ti :80 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@sudo lsof -ti :443 -sTCP:LISTEN | xargs -r sudo kill -9 || true

	@echo "$(CYAN)üîç Checking for any residual Nginx listeners...$(RESET)"
	@if sudo lsof -i :80 -sTCP:LISTEN | grep -q nginx || \
		sudo lsof -i :443 -sTCP:LISTEN | grep -q nginx; then \
		echo "$(RED)‚ö†Ô∏è Some Nginx processes still active!$(RESET)"; \
	else \
		echo "$(GREEN)‚úÖ All Nginx processes stopped and ports freed.$(RESET)"; \
	fi



restart:
	@echo "$(YELLOW)üîÑ Restarting Nginx...$(RESET)"
	@sudo systemctl restart nginx && echo "$(GREEN)‚úÖ Restarted successfully.$(RESET)" || echo "$(RED)‚ùå Restart failed.$(RESET)"


reload:
	@echo "$(YELLOW)üîÅ Reloading Nginx configuration...$(RESET)"
	@sudo systemctl reload nginx && echo "$(GREEN)‚úÖ Reloaded.$(RESET)" || echo "$(RED)‚ùå Reload failed.$(RESET)"


restart-clean:
	@echo "$(YELLOW)üîÑ Performing clean restart...$(RESET)"
	@$(MAKE) stop
	@$(MAKE) free-ports
	@$(MAKE) start
	@echo "$(GREEN)‚úÖ Clean restart completed.$(RESET)"


free-ports:
	@echo "$(YELLOW)üßπ Releasing ports 80 & 443...$(RESET)"
	@sudo lsof -ti :80 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@sudo lsof -ti :443 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@echo "$(GREEN)‚úÖ Ports released.$(RESET)"


# ==========================================================
# 6Ô∏è‚É£ SSL CONFIGURATION (LETSENCRYPT / SELF-SIGNED)
# ==========================================================
enable-ssl:
	@echo "$(YELLOW)üîí Configuring SSL for $(DOMAIN)...$(RESET)"
	@sudo apt install -y certbot python3-certbot-nginx
	@if sudo certbot --nginx -d $(DOMAIN) -d www.$(DOMAIN); then \
		echo "$(GREEN)‚úÖ SSL installed successfully.$(RESET)"; \
	else \
		echo "$(RED)‚ö†Ô∏è Certbot failed ‚Äî generating self-signed certificate.$(RESET)"; \
		sudo mkdir -p /etc/nginx/ssl; \
		sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
			-keyout /etc/nginx/ssl/selfsigned.key \
			-out /etc/nginx/ssl/selfsigned.crt \
			-subj "/CN=$(DOMAIN)"; \
	fi
	@sudo certbot renew --dry-run || true


# ==========================================================
# 7Ô∏è‚É£ TEST LIVE SITE RESPONSE
# ==========================================================
test-site:
	@echo "$(YELLOW)üåç Checking site availability...$(RESET)"
	@curl -s --max-time 5 http://$(DOMAIN) | grep -qi "html" && echo "$(GREEN)‚úÖ HTTP OK$(RESET)" || echo "$(RED)‚ùå HTTP failed$(RESET)"
	@curl -s -k --max-time 5 https://$(DOMAIN) | grep -qi "html" && echo "$(GREEN)‚úÖ HTTPS OK$(RESET)" || echo "$(RED)‚ùå HTTPS failed$(RESET)"


# ==========================================================
# 8Ô∏è‚É£ ROLLBACK & FULL CLEANUP
# ==========================================================
rollback-config:
	@echo "$(YELLOW)‚è™ Restoring default configuration...$(RESET)"
	@if [ -f "$(DEFAULT_CONF)" ]; then \
		sudo ln -sf $(DEFAULT_CONF) $(NGINX_ENABLED_DIR)/default; \
		sudo rm -f $(CONFIG_FILE); \
		echo "$(GREEN)‚úÖ Default configuration restored.$(RESET)"; \
	else \
		echo "$(RED)‚ö†Ô∏è Default config not found.$(RESET)"; \
	fi
	@sudo systemctl restart nginx || true


clean:
	@echo "$(YELLOW)üßπ Performing full cleanup for $(DOMAIN)...$(RESET)"
	@echo "$(CYAN)‚èπÔ∏è  Stopping Nginx service...$(RESET)"
	@sudo systemctl stop nginx >/dev/null 2>&1 || true
	@sudo pkill -f nginx >/dev/null 2>&1 || true

	@echo "$(CYAN)üßπ  Releasing occupied ports (80/443)...$(RESET)"
	@sudo lsof -ti :80 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@sudo lsof -ti :443 -sTCP:LISTEN | xargs -r sudo kill -9 || true

	@echo "$(CYAN)üóëÔ∏è  Removing Nginx configs and symlinks...$(RESET)"
	@sudo rm -f $(CONFIG_FILE) $(NGINX_ENABLED_DIR)/$(DOMAIN) || true
	@sudo rm -f $(NGINX_ENABLED_DIR)/default || true

	@echo "$(CYAN)üßΩ  Cleaning temporary Nginx cache/logs...$(RESET)"
	@sudo rm -rf /var/cache/nginx/* /var/log/nginx/* || true

	@echo "$(CYAN)üîí  Removing expired or self-signed certificates (optional)...$(RESET)"
	@sudo rm -rf /etc/letsencrypt/live/$(DOMAIN) \
		/etc/letsencrypt/archive/$(DOMAIN) \
		/etc/nginx/ssl/selfsigned.* 2>/dev/null || true

	@echo "$(CYAN)üîç  Verifying cleanup status...$(RESET)"
	@if sudo lsof -i :80 -sTCP:LISTEN | grep -q nginx || \
		sudo lsof -i :443 -sTCP:LISTEN | grep -q nginx; then \
		echo "$(RED)‚ö†Ô∏è Some Nginx processes still hold ports.$(RESET)"; \
	else \
		echo "$(GREEN)‚úÖ All Nginx resources released successfully.$(RESET)"; \
	fi

	@echo "$(GREEN)üéØ Cleanup complete. System is now Nginx-free.$(RESET)"
