############################################################
# ğŸ§± Makefile â€” PostgreSQL + pgAdmin Automation
# ----------------------------------------------------------
# Usage:
#   make install-pg         â†’ Install PostgreSQL
#   make install-pgadmin    â†’ Install pgAdmin
#   make update-all         â†’ Update both PostgreSQL & pgAdmin
#   make restart-all        â†’ Restart both services
#   make test-db            â†’ Test PostgreSQL connection
#   make clean              â†’ Remove everything
############################################################

SHELL := /bin/bash

# ==========================================================
# âš™ï¸ CONFIGURATION
# ==========================================================
DB_USER = gpuuserdb
DB_PASS = Imr@n786
DB_NAME = gpuminingdb
DB_PORT = 5432
PGADMIN_PORT = 5050

SERVER_IP := $(shell curl -s ifconfig.me || echo "localhost")
ENCODED_PASS := $(shell python3 -c "import urllib.parse; print(urllib.parse.quote('$(DB_PASS)'))")

DATABASE_URL = postgresql://$(DB_USER):$(ENCODED_PASS)@$(SERVER_IP):$(DB_PORT)/$(DB_NAME)?sslmode=disable

# ==========================================================
# ğŸ“¦ INSTALL TARGETS
# ==========================================================
install-pg:
	@echo "ğŸš€ Installing PostgreSQL via db.sh..."
	@chmod +x db.sh
	@sudo ./db.sh
	@echo "âœ… PostgreSQL installation completed!"
	@echo "ğŸ”— DATABASE_URL: $(DATABASE_URL)"

install-pgadmin:
	@echo "ğŸš€ Installing pgAdmin via pgadmin.sh..."
	@chmod +x pgadmin.sh
	@sudo ./pgadmin.sh
	@echo "âœ… pgAdmin installation completed!"
	@echo "ğŸŒ Access: http://$(SERVER_IP):$(PGADMIN_PORT)"

setup-all: install-pg install-pgadmin
	@echo "âœ… Full setup completed (PostgreSQL + pgAdmin)!"

# ==========================================================
# ğŸ”„ UPDATE TARGETS
# ==========================================================
update-pg:
	@echo "ğŸ”„ Updating PostgreSQL packages..."
	@sudo apt update -y
	@sudo apt install -y postgresql postgresql-contrib
	@sudo systemctl restart postgresql
	@sudo systemctl status postgresql --no-pager
	@echo "âœ… PostgreSQL update complete!"

update-pgadmin:
	@echo "ğŸ”„ Updating pgAdmin (via pip)..."
	@if [ -d "/opt/pgadmin4" ]; then \
		cd /opt/pgadmin4 && source venv/bin/activate && pip install --upgrade pgadmin4; \
		sudo systemctl restart pgadmin; \
		sudo systemctl status pgadmin --no-pager; \
	else \
		echo "âš ï¸ pgAdmin not found at /opt/pgadmin4. Try: make install-pgadmin"; \
	fi
	@echo "âœ… pgAdmin update complete!"

update-all: update-pg update-pgadmin
	@echo "âœ… All updates applied successfully!"

# ==========================================================
# ğŸ” RESTART TARGETS
# ==========================================================
restart-pg:
	@echo "ğŸ” Restarting PostgreSQL..."
	@sudo systemctl restart postgresql
	@sudo systemctl status postgresql --no-pager
	@echo "âœ… PostgreSQL restarted successfully!"

restart-pgadmin:
	@echo "ğŸ” Restarting pgAdmin..."
	@sudo systemctl restart pgadmin || echo "âš ï¸ pgAdmin service not found."
	@sudo systemctl status pgadmin --no-pager || true
	@echo "âœ… pgAdmin restart attempted!"

restart-all: restart-pg restart-pgadmin
	@echo "âœ… Both PostgreSQL and pgAdmin restarted successfully!"

# ==========================================================
# ğŸ§ª TEST TARGETS
# ==========================================================
test-db:
	@echo "ğŸ§ª Testing PostgreSQL connection..."
	@if PGPASSWORD="$(DB_PASS)" psql -h "$(SERVER_IP)" -U "$(DB_USER)" -d "$(DB_NAME)" -p "$(DB_PORT)" -c "SELECT version();" >/dev/null 2>&1; then \
		echo "âœ… Connection successful!"; \
		echo "ğŸ”— URL: $(DATABASE_URL)"; \
	else \
		echo "âŒ Connection failed. Check credentials or firewall."; \
	fi

test-pgadmin:
	@echo "ğŸ§ª Testing pgAdmin web service..."
	@STATUS_CODE=$$(curl -s -o /tmp/pgadmin_test.html -w "%{http_code}" http://$(SERVER_IP):$(PGADMIN_PORT)); \
	if [ "$$STATUS_CODE" -eq 200 ] || [ "$$STATUS_CODE" -eq 302 ] || grep -qi "pgadmin" /tmp/pgadmin_test.html; then \
		echo "âœ… pgAdmin is running and reachable at: http://$(SERVER_IP):$(PGADMIN_PORT)"; \
	else \
		echo "âŒ pgAdmin not responding (HTTP $$STATUS_CODE)."; \
		echo "âš ï¸ Try checking service logs:"; \
		echo "   sudo journalctl -u pgadmin -n 20 --no-pager"; \
	fi; \
	rm -f /tmp/pgadmin_test.html



test-all: test-db test-pgadmin
	@echo "âœ… All tests completed!"

# ==========================================================
# ğŸ§¹ CLEANUP
# ==========================================================
clean:
	@echo "ğŸ§¹ Removing PostgreSQL and pgAdmin..."
	@sudo systemctl stop pgadmin postgresql || true
	@sudo systemctl disable pgadmin postgresql || true
	@sudo apt purge -y postgresql postgresql-contrib || true
	@sudo apt autoremove -y
	@sudo rm -rf /var/lib/postgresql /etc/postgresql /opt/pgadmin4 /var/lib/pgadmin /var/log/pgadmin /etc/systemd/system/pgadmin.service || true
	@sudo systemctl daemon-reload
	@echo "âœ… Cleanup completed."

# ==========================================================
# ğŸ§­ HELP
# ==========================================================
help:
	@echo "============================================================"
	@echo "ğŸ§­ PostgreSQL + pgAdmin Makefile Commands"
	@echo "------------------------------------------------------------"
	@echo "ğŸ”¹ make install-pg         â†’ Install PostgreSQL via db.sh"
	@echo "ğŸ”¹ make install-pgadmin    â†’ Install pgAdmin via pgadmin.sh"
	@echo "ğŸ”¹ make setup-all          â†’ Install both PostgreSQL + pgAdmin"
	@echo "------------------------------------------------------------"
	@echo "ğŸ”¹ make update-pg          â†’ Update PostgreSQL"
	@echo "ğŸ”¹ make update-pgadmin     â†’ Update pgAdmin"
	@echo "ğŸ”¹ make update-all         â†’ Update both"
	@echo "------------------------------------------------------------"
	@echo "ğŸ”¹ make restart-pg         â†’ Restart PostgreSQL"
	@echo "ğŸ”¹ make restart-pgadmin    â†’ Restart pgAdmin"
	@echo "ğŸ”¹ make restart-all        â†’ Restart both services"
	@echo "------------------------------------------------------------"
	@echo "ğŸ”¹ make test-db            â†’ Test PostgreSQL connection"
	@echo "ğŸ”¹ make test-pgadmin       â†’ Test pgAdmin web status"
	@echo "ğŸ”¹ make test-all           â†’ Test both"
	@echo "------------------------------------------------------------"
	@echo "ğŸ”¹ make clean              â†’ Uninstall all components"
	@echo "------------------------------------------------------------"
	@echo "ğŸ“¡ Server IP: $(SERVER_IP)"
	@echo "ğŸ”— DATABASE_URL: $(DATABASE_URL)"
	@echo "============================================================"
